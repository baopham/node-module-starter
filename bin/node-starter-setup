#!/usr/bin/env node

const path = require('path');
const fs = require('fs-extra');
const { execSync } = require('child_process');
const inquirer = require('inquirer');
const chalk = require('chalk');
const program = require('commander');
const print = console.log;

program
  .option('--skip-files', 'Skip setting up files (e.g. travis, editorconfig, git hooks, etc.)')
  .option('--skip-deps', 'Skip installing dependencies')
  .option('--skip-scripts', 'Skip setting up npm scripts')
  .option('--override-files', 'Override current config files but will not remove any existing files')
  .option('--override-scripts', 'Override the current npm scripts but will not remove any existing scripts')
  .parse(process.argv);

setup();

function setup() {
  setupProject();
  setupFiles();
  setupDependencies().then(setupScripts).then(done);
}

function setupProject() {
  if (!fs.pathExistsSync(path.resolve('package.json'))) {
    execSync('npm init', { stdio: 'inherit' });
  }
}

function setupFiles() {
  if (program.skipFiles) return;

  const items = [
    '.travis.yml',
    '.editorconfig',
    '.eslintrc',
    '.gitignore',
    '.flowconfig',
    '.babelrc',
    '.lintstagedrc'
  ];

  items.forEach(item => {
    const filename = item.replace(/^\./, '');
    const dest = path.resolve(item);
    const source = path.resolve(path.join(__dirname, '..', 'templates', filename));
    fs.copySync(source, dest, { overwrite: program.overrideFiles });
  });

  print(chalk.green('Done setting up necessary files'));
}

function setupDependencies() {
  if (program.skipDeps) return Promise.resolve();

  print(chalk.green('About to install all the common dependencies...'));

  return inquirer.prompt([
    {
      type: 'confirm',
      name: 'useYarn',
      message: 'Do you want to use yarn?'
    },
    {
      type: 'confirm',
      name: 'useJest',
      message: 'Do you want to use jest?'
    },
  ]).then(install);

  function install(answers) {
    const devDeps = [
      'eslint',
      'eslint-config-pretty-standard',
      'eslint-plugin-import',
      'prettier',
      '@babel/cli',
      '@babel/core',
      '@babel/preset-env',
      '@babel/preset-flow',
      'babel-eslint',
      'flow-bin',
      'lint-staged',
      'husky'
    ];

    if (answers.useJest) {
      devDeps.push('jest');
    }

    const cmd = answers.useYarn ? 'yarn add --dev' : 'npm install --save-dev';

    execSync(`${cmd} ${devDeps.join(' ')}`, { stdio: 'inherit' });

    return answers;
  }
}

function setupScripts(answers) {
  if (program.skipScripts) return;

  const packagePath = path.resolve('package.json');
  const package = require(packagePath);

  if (!package.scripts) package.scripts = {};

  const repo = package.name;
  const baseTest = 'npm run lint && npm run flow';

  const scripts = {
    test: answers.useJest ? `${baseTest} jest` : baseTest,
    build: 'babel src/ -d lib/',
    lint: 'eslint ./src/**/*.js',
    prettier: 'prettier --write --single-quote ./src/**/*.js',
    preversion: 'npm test && npm run build && git add -f lib',
    flow: 'flow',
    precommit: 'lint-staged'
  };

  Object.keys(scripts).forEach(command => {
    if (!program.overrideScripts && package.scripts[command]) return;
    package.scripts[command] = scripts[command];
  });

  fs.writeJson(packagePath, package, { spaces: 2 });
}

function done() {
  print(chalk.green('Done!'));
}
